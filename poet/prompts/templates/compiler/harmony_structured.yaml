name: "harmony_structured"
description: "Generate structured Harmony data compatible with openai_harmony library"
category: "compiler"
parameters:
  - user_prompt
  - initial_constraints
  - execution_steps
  - final_poem
  - quality_assessment
  - conversation_start_date
  - cursor
  - toolname
  - line_start
  - line_end
  - name
  - output
  - id
  - long_chain_of_thought

template: |
  أنت خبير في تحليل عمليات توليد الشعر العربي وتحتاج إلى إعادة بناء عملية التفكير بتنسيق OpenAI Harmony.
  
  CRITICAL: أنت تحاكي وكيل ذكي يقوم بتحليل عملية توليد الشعر العربي.
  ليس لديك إمكانية الوصول إلى أي أدوات - فقط قم بتحليل البيانات المدخلة والمخرجات.
  لا تذكر أسماء أي أدوات أو نداءات تنفيذ أو وظائف داخلية. تصرّف وكأنك تبني خريطة أسباب ونتائج من منظورك الداخلي فقط.
  اتّبع حقائق التنفيذ الواردة في البيانات (execution_steps، final_poem، quality_assessment) دون تسميتها صراحة، واستخلص منها الوقائع ثم اروِ تفكيرك كتحليل ذاتي.
  قسّم التفكير إلى خطوات صغيرة إلى متوسطة قدر الإمكان. تجنّب دمج التوليد والتقييم في خطوة واحدة عندما لا تكون الخطوات قصيرة جدًا.
  
  # تعليمات خاصة بمعالجة خطوات الأنبوب
  
  ## تحليل خطوات التنفيذ
  عند استعراض تسلسل العمل، قم بإنشاء تفكير طبيعي يوضح:
  - ما تم تحليله من قيود ومتطلبات
  - القرارات التي تم اتخاذها وسببها
  - ربط كل خطوة منطقياً بالخطوة التالية
  - التأمل في الجودة والمشاكل الموجودة
  - شرح قرارات التحسين
  
  ## محاور التحليل المتوقعة (دون ذكر أسماء أدوات)
  
  - تحليل القافية: استنبط القافية المطلوبة من القيود والمخرجات النهائية، واشرح لماذا هذا النمط مناسب.
  - تحليل البحر والوزن: استنبط البحر والتفعيلات من القيود والمخرجات النهائية، واشرح طريقة التحقق من الوزن.
  - توليد وتحسين الأبيات: برّر اختيار الأسطر المستهدفة للتحسين وما الذي تغير ولماذا.
  - التقييم النهائي: اربط ملاحظات الجودة بالقيود الأصلية ونتيجة القصيدة.

  # بيانات التنفيذ
  
  النص المطلوب من المستخدم: {user_prompt}
  القيود الأولية: {initial_constraints}
  
  # خطوات الأنبوب المنفذة
  
  {execution_steps}
  
  # المخرجات النهائية
  القصيدة النهائية: {final_poem}
  تقييم الجودة: {quality_assessment}
  
  # المهمة
  
  قم بتوليد محادثة Harmony كاملة تظهر عملية توليد الشعر كما لو أن الذكاء الاصطناعي
  يفكر في كل خطوة. يتضمن:
  
  1. رسالة نظام بمستوى تفكير "عالي"
  2. رسالة مطور بتعليمات توليد الشعر (من دون الإشارة إلى أي أدوات أو نداءات)
  3. رسالة مستخدم بالنص المطلوب والقيود
  4. رسائل مساعد تظهر:
     - التفكير المتسلسل في رسائل <|channel|>analysis
     - المخرجات النهائية في رسائل <|channel|>final
  
  لكل خطوة في الأنبوب، قم بإنشاء تفكير طبيعي يوضح:
  - ما يفكر فيه الذكاء الاصطناعي (استخدم <|channel|>analysis للتفكير المتسلسل)
  - لماذا تم اتخاذ قرارات معينة
  - ربط كل خطوة منطقياً بالخطوة التالية
  - التأمل في الجودة والمشاكل الموجودة
  - شرح قرارات التحسين
  
  # القيود المهمة
  
  - لا تستخدم أي أدوات - ركز على التحليل والتفكير فقط
  - لا تذكر أو تلمّح إلى أدوات توليد الشعر الداخلية (مثل QafiyaSelector أو RefinerChain أو PoemEvaluator) أو أسماء نداءات التنفيذ.
  - يجب أن يكون كل التفكير والتحليل في قناة analysis
  - يجب أن تكون المخرجات النهائية في قناة final
  - يجب أن يشعر التفكير بأنه عملية تفكير متماسكة، وليس مجرد قائمة ميكانيكية من الخطوات
  - التزم بخطوات صغيرة إلى متوسطة. إذا كانت المهمة تسمح، افصل بين التوليد، والمراجعة الوزنية، ومراجعة القافية، والتحسين، ثم التقييم.
  - **مهم جداً: يجب أن تنتهي المحادثة برسالة واحدة في قناة final تحتوي على القصيدة النهائية وتقييم الجودة**
  
  # تعليمات القنوات
  - قناة analysis: للتفكير والتحليل المتسلسل حول كل خطوة في الأنبوب
  - قناة final: للمخرجات النهائية (القصيدة وتقييم الجودة) - **رسالة واحدة مطلوبة في النهاية**
  - لا تستخدم قناة commentary في هذه المرحلة
  
  # هيكل المحادثة المطلوب
  1. رسالة نظام
  2. رسالة مطور
  3. رسالة مستخدم
  4. رسائل مساعد في قناة analysis (للتفكير والتحليل)
  5. **رسالة نهائية واحدة في قناة final (مطلوبة)**
  
  # ملاحظة مهمة
  بعد الانتهاء من جميع رسائل التحليل في قناة analysis، يجب أن تنتهي المحادثة برسالة واحدة في قناة final تحتوي على:
  - القصيدة النهائية كاملة
  - تقييم الجودة النهائي
  - أي ملاحظات ختامية

  # تعليمات الانتقال إلى النتيجة النهائية
  عندما تُتمّ التحليل:
  1) توقّف عن كتابة المزيد في قناة analysis.
  2) اكتب رسالة واحدة فقط في قناة final.
  3) ضَع القصيدة النهائية كاملة (استخدم {final_poem} كأساس دون تحريف).
  4) أضِف تقييم الجودة النهائي (استخدم {quality_assessment} كأساس دون تحريف).
  5) أنهِ المحادثة بعد رسالة final.

  ابدأ ردك بـ:
  <|start|>system<|message|>أنت وكيل توليد الشعر العربي.
  Knowledge cutoff: 2024-06
  Current date: {conversation_start_date}
  Reasoning: high
  # Valid channels: analysis, final. Channel must be included for every message.<|end|>

  ثم أضف رسالة المستخدم:
  <|start|>user<|channel|>analysis<|message|>أريد توليد شعر عربي<|end|>

  ثم أضف رسائل المساعد مع القنوات المناسبة:
  <|start|>assistant<|channel|>analysis<|message|>سأقوم بتحليل متطلباتك...<|end|>
  <|start|>assistant<|channel|>final<|message|>هنا القصيدة النهائية...<|end|> 